{% extends 'base.html' %}

{% block title %}Edit Profile | TaskFlow{% endblock %}
{% block page_header %}Settings{% endblock %}

{% block content %}
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-white {% if message.tags == 'success' %}bg-success{% elif message.tags == 'error' %}bg-danger{% else %}bg-primary{% endif %} border-0 show" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

<div class="animate__animated animate__fadeInUp">
    
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-0">Account Settings</h4>
            <p class="text-muted small mb-0">Update your profile information and how others see you on TaskFlow.</p>
        </div>
        <a href="{% url 'accounts:profile' %}" class="btn btn-light btn-sm border text-muted fw-bold shadow-sm">
            <i class="fas fa-arrow-left me-1"></i> Back to Profile
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card-custom shadow-sm border-0 p-4 bg-white rounded-3">
                <form method="post" enctype="multipart/form-data" novalidate id="profile-form">
                    {% csrf_token %}
                    
                    <h6 class="text-primary fw-bold text-uppercase small mb-4 pb-2 border-bottom">
                        <i class="fas fa-camera me-2"></i>Profile Picture
                    </h6>
                    
                    <div class="d-flex align-items-center gap-4 p-4 mb-5 border rounded-3 bg-light-subtle shadow-sm">
                        <div class="position-relative">
                            {% if user.profile.avatar %}
                                <img id="avatar-main-preview" src="{{ user.profile.avatar.url }}" 
                                     class="rounded-circle border border-4 border-white shadow-sm object-fit-cover" 
                                     width="120" height="120">
                            {% else %}
                                <img id="avatar-main-preview" src="https://ui-avatars.com/api/?name={{ user.username }}&background=6366f1&color=fff&size=128" 
                                     class="rounded-circle border border-4 border-white shadow-sm" 
                                     width="120" height="120">
                            {% endif %}
                            <label for="{{ form.avatar.id_for_label }}" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow" style="width: 38px; height: 38px; cursor: pointer; border: 3px solid white;">
                                <i class="fas fa-pen fa-sm"></i>
                            </label>
                        </div>

                        <div class="flex-grow-1">
                            <label class="form-label fw-bold text-dark mb-1">Change Avatar</label>
                            <div class="custom-file-input-wrapper">
                                {{ form.avatar }}
                            </div>
                            <p class="small text-muted mb-0 mt-2">
                                <i class="fas fa-info-circle me-1"></i> Square JPG or PNG, max 2MB.
                            </p>
                            {% if form.avatar.errors %}
                                <div class="invalid-feedback d-block">{{ form.avatar.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <h6 class="text-primary fw-bold text-uppercase small mb-4 pb-2 border-bottom">
                        <i class="fas fa-user-circle me-2"></i>Personal Information
                    </h6>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark">First Name <span class="text-danger">*</span></label>
                            {{ form.first_name }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark">Last Name</label>
                            {{ form.last_name }}
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fw-semibold text-dark">Email Address <span class="text-danger">*</span></label>
                        {{ form.email }}
                    </div>

                    <h6 class="text-primary fw-bold text-uppercase small mb-4 pb-2 border-bottom">
                        <i class="fas fa-briefcase me-2"></i>Professional Details
                    </h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark">Department</label>
                            {{ form.department }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark">Phone Number</label>
                            {{ form.phone }}
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label fw-semibold text-dark">Bio</label>
                        {{ form.bio }}
                    </div>

                    <div class="bg-light p-4 rounded-3 d-flex justify-content-end gap-3 border">
                        <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary px-4 fw-bold">Cancel</a>
                        <button type="submit" class="btn btn-primary-custom px-5 fw-bold shadow-sm" id="save-btn">
                            <span class="spinner-border spinner-border-sm d-none me-2" id="save-spinner" role="status"></span>
                            <i class="fas fa-save me-2" id="save-icon"></i> Update Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-custom bg-light border-0 mb-4 p-4 rounded-3">
                <h6 class="fw-bold mb-3"><i class="fas fa-lightbulb text-warning me-2"></i>Quick Tips</h6>
                <p class="small text-muted mb-0">Providing a professional bio and department helps your team members know your expertise when assigning tasks.</p>
            </div>
            
            <div class="card-custom border-dashed text-center py-4 px-3 rounded-3">
                <i class="fas fa-shield-alt text-muted opacity-50 mb-3 fs-1"></i>
                <h6 class="fw-bold">Account Security</h6>
                <p class="small text-muted">Update your login credentials.</p>
                <a href="{% url 'accounts:password_change' %}" class="btn btn-light btn-sm border fw-bold text-muted mt-1">Change Password</a>
            </div>
        </div>
    </div>
</div>

<style>
    :root { --primary: #6366f1; --primary-dark: #4f46e5; }

    .form-control {
        padding: 0.65rem 1rem;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        transition: 0.2s;
    }

    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .bg-light-subtle { background-color: #f9fafb !important; }
    .object-fit-cover { object-fit: cover; }
    .border-dashed { border: 2px dashed #e5e7eb !important; }

    .btn-primary-custom {
        background-color: var(--primary);
        border: none;
        color: white;
        border-radius: 8px;
        transition: 0.3s;
    }

    .btn-primary-custom:hover:not(:disabled) { 
        background-color: var(--primary-dark); 
        transform: translateY(-1px); 
    }

    input[type="file"]::file-selector-button {
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        padding: 6px 14px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 12px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Avatar Preview Logic
        const avatarInput = document.querySelector('input[type="file"]');
        const mainPreview = document.getElementById('avatar-main-preview');

        if (avatarInput) {
            avatarInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (mainPreview) mainPreview.src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // 2. Bootstrap Toast Initialization
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl, { delay: 5000 }).show()
        });

        // 3. Spinner Logic on Submit
        const profileForm = document.getElementById('profile-form');
        const saveBtn = document.getElementById('save-btn');
        const spinner = document.getElementById('save-spinner');
        const icon = document.getElementById('save-icon');

        profileForm.addEventListener('submit', function() {
            spinner.classList.remove('d-none');
            icon.classList.add('d-none');
            saveBtn.disabled = true;
        });
    });
</script>
{% endblock %}